name: Daily LinkedIn Content Generation

on:
  schedule:
    # Run at 8:00 AM UTC (adjust for your timezone)
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if API limits are reached'
        required: false
        default: 'false'

permissions:
  contents: write
  issues: write
  statuses: write
  actions: read

env:
  NODE_VERSION: '18'

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Puppeteer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gconf-service \
          libasound2 \
          libatk1.0-0 \
          libc6 \
          libcairo2 \
          libcups2 \
          libdbus-1-3 \
          libexpat1 \
          libfontconfig1 \
          libgcc1 \
          libgconf-2-4 \
          libgdk-pixbuf2.0-0 \
          libglib2.0-0 \
          libgtk-3-0 \
          libnspr4 \
          libpango-1.0-0 \
          libpangocairo-1.0-0 \
          libstdc++6 \
          libx11-6 \
          libx11-xcb1 \
          libxcb1 \
          libxcomposite1 \
          libxcursor1 \
          libxdamage1 \
          libxext6 \
          libxfixes3 \
          libxi6 \
          libxrandr2 \
          libxrender1 \
          libxss1 \
          libxtst6 \
          ca-certificates \
          fonts-liberation \
          libappindicator1 \
          libnss3 \
          lsb-release \
          xdg-utils \
          wget

    - name: Create .env file
      run: |
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env

    - name: Check API Usage Limits
      id: check-limits
      run: |
        npx ts-node -e "
        import { checkApiLimits, displayUsageStats } from './api-usage-monitor';
        (async () => {
          const limits = await checkApiLimits(2, 1500);
          console.log('API_LIMIT_CHECK=' + JSON.stringify(limits));
          await displayUsageStats();
          process.exit(limits.canProceed ? 0 : 1);
        })();
        " | tee api_check.log || echo "API_LIMIT_EXCEEDED=true" >> $GITHUB_OUTPUT

    - name: Generate Content
      if: steps.check-limits.outcome == 'success' || github.event.inputs.force_run == 'true'
      run: |
        npx ts-node programming-content.ts | tee generation.log

    - name: Get Current Usage Stats
      id: usage-stats
      run: |
        npx ts-node -e "
        import { getCurrentUsage } from './api-usage-monitor';
        (async () => {
          const usage = await getCurrentUsage();
          console.log('USAGE_STATS=' + JSON.stringify(usage));
        })();
        " | tee usage_stats.log
        
        # Extract usage stats and set outputs
        USAGE_OUTPUT=$(cat usage_stats.log | grep 'USAGE_STATS=' | cut -d'=' -f2-)
        if [ ! -z "$USAGE_OUTPUT" ]; then
          DAILY_REQUESTS=$(echo $USAGE_OUTPUT | jq -r '.dailyRequests // 0')
          DAILY_TOKENS=$(echo $USAGE_OUTPUT | jq -r '.dailyTokens // 0')
          REQUESTS_REMAINING=$((50 - $DAILY_REQUESTS))
          TOKENS_REMAINING=$((32000 - $DAILY_TOKENS))
          USAGE_PERCENTAGE=$(($DAILY_REQUESTS * 100 / 50))
          
          echo "DAILY_REQUESTS=$DAILY_REQUESTS" >> $GITHUB_OUTPUT
          echo "DAILY_TOKENS=$DAILY_TOKENS" >> $GITHUB_OUTPUT
          echo "REQUESTS_REMAINING=$REQUESTS_REMAINING" >> $GITHUB_OUTPUT
          echo "TOKENS_REMAINING=$TOKENS_REMAINING" >> $GITHUB_OUTPUT
          echo "USAGE_PERCENTAGE=$USAGE_PERCENTAGE" >> $GITHUB_OUTPUT
        else
          echo "DAILY_REQUESTS=0" >> $GITHUB_OUTPUT
          echo "DAILY_TOKENS=0" >> $GITHUB_OUTPUT
          echo "REQUESTS_REMAINING=50" >> $GITHUB_OUTPUT
          echo "TOKENS_REMAINING=32000" >> $GITHUB_OUTPUT
          echo "USAGE_PERCENTAGE=0" >> $GITHUB_OUTPUT
        fi

    - name: Create Usage Report
      run: |
        cat > usage_report.md << 'EOF'
        # ğŸ“Š Daily API Usage Report

        **Generated on:** $(date)

        ## ğŸ”‘ Gemini API Usage
        - **Requests Used:** ${{ steps.usage-stats.outputs.DAILY_REQUESTS }}/50
        - **Tokens Used:** ${{ steps.usage-stats.outputs.DAILY_TOKENS }}/32,000
        - **Requests Remaining:** ${{ steps.usage-stats.outputs.REQUESTS_REMAINING }}
        - **Tokens Remaining:** ${{ steps.usage-stats.outputs.TOKENS_REMAINING }}
        - **Usage Percentage:** ${{ steps.usage-stats.outputs.USAGE_PERCENTAGE }}%

        ## ğŸ“ˆ Status
        ${{ steps.check-limits.outcome == 'success' && 'âœ… Content generated successfully' || 'âš ï¸ API limits reached' }}

        ## ğŸ“ Generated Content
        Check the `content_$(date +%Y-%m-%d)` folder for today's posts.

        ---
        *This report is automatically generated by the LinkedIn Content Engine*
        EOF

    - name: Upload Content Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: daily-content-${{ github.run_number }}
        path: |
          content_*
          *.log
          usage_report.md
        retention-days: 30

    - name: Update README with Usage Stats
      run: |
        # Update README with current usage
        sed -i "s/Daily Requests: .*/Daily Requests: ${{ steps.usage-stats.outputs.DAILY_REQUESTS }}\/50/" README.md
        sed -i "s/Daily Tokens: .*/Daily Tokens: ${{ steps.usage-stats.outputs.DAILY_TOKENS }}\/32,000/" README.md
        sed -i "s/Last Updated: .*/Last Updated: $(date)/" README.md

    - name: Commit Usage Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md api-usage.json || true
        if [[ -n $(git status --porcelain) ]]; then
          git commit -m "ğŸ“Š Update API usage stats - $(date)"
        else
          echo "No changes to commit"
        fi

    - name: Push changes
      if: always()
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          git push origin main
        else
          echo "No changes to push"
        fi

    - name: Create Issue on API Limit Reached
      if: steps.check-limits.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const dailyRequests = '${{ steps.usage-stats.outputs.DAILY_REQUESTS }}' || '0';
          const dailyTokens = '${{ steps.usage-stats.outputs.DAILY_TOKENS }}' || '0';
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'âš ï¸ API Limits Reached - ' + new Date().toDateString(),
            body: `## API Usage Alert
            
            The daily API limits have been reached:
            - Requests: ${dailyRequests}/50
            - Tokens: ${dailyTokens}/32,000
            
            Content generation was skipped for today. The limits will reset at midnight UTC.
            
            **Action Required:** Monitor usage or consider upgrading the API plan if this becomes frequent.
            `,
            labels: ['api-usage', 'alert']
          });

    - name: Post Status to Repository
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const isSuccess = '${{ steps.check-limits.outcome }}' === 'success';
          const status = isSuccess ? 'âœ… Success' : 'âš ï¸ Limited';
          const usage = '${{ steps.usage-stats.outputs.USAGE_PERCENTAGE }}' || '0';
          
          github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            state: isSuccess ? 'success' : 'failure',
            description: `API Usage: ${usage}% | Status: ${status}`,
            context: 'Daily Content Generation'
          });
